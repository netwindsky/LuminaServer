# LuminaServer 项目类说明文档

## 概述
本文档记录了 LuminaServer 项目中所有类的说明，包括类名、路径、功能描述、对外调用接口和使用方式。

---

## 1. 消息编解码模块 (Message Codec)

### 1.1 MessageCodec
- **路径**: `com.whale.lumina.codec.MessageCodec`
- **功能**: WebSocket消息的编解码处理
- **主要接口**:
  - `encode(Object message)`: 编码消息对象为字节数组
  - `decode(byte[] data)`: 解码字节数组为消息对象
  - `encodeText(Object message)`: 编码消息为文本格式
  - `decodeText(String text)`: 解码文本消息
- **使用方式**: 
  ```java
  MessageCodec codec = new MessageCodec();
  byte[] encoded = codec.encode(messageObject);
  Object decoded = codec.decode(encoded);
  ```

---

## 2. 房间管理模块 (Room Management)

### 2.1 Room
- **路径**: `com.whale.lumina.room.Room`
- **功能**: 游戏房间实体类，管理房间状态和玩家
- **主要属性**: roomId, name, gameMode, status, maxPlayers, players, settings
- **主要方法**:
  - `addPlayer(Player player)`: 添加玩家到房间
  - `removePlayer(String playerId)`: 从房间移除玩家
  - `updateSettings(RoomSettings settings)`: 更新房间设置
  - `startGame()`: 开始游戏
  - `endGame()`: 结束游戏

### 2.2 RoomManager
- **路径**: `com.whale.lumina.room.RoomManager`
- **功能**: 房间管理器，负责房间的创建、销毁和管理
- **主要接口**:
  - `createRoom(CreateRoomRequest request)`: 创建新房间
  - `joinRoom(String roomId, String playerId)`: 玩家加入房间
  - `leaveRoom(String roomId, String playerId)`: 玩家离开房间
  - `getRoomById(String roomId)`: 根据ID获取房间
  - `getActiveRoomCount()`: 获取活跃房间数量 **[新增]**
- **使用方式**:
  ```java
  @Autowired
  private RoomManager roomManager;
  
  Room room = roomManager.createRoom(createRequest);
  roomManager.joinRoom(roomId, playerId);
  ```

### 2.3 RoomStore
- **路径**: `com.whale.lumina.room.RoomStore`
- **功能**: 房间数据存储，使用Redis进行持久化
- **主要接口**:
  - `saveRoom(Room room)`: 保存房间数据
  - `getRoom(String roomId)`: 获取房间数据
  - `deleteRoom(String roomId)`: 删除房间数据
  - `getRoomsByStatus(Room.Status status)`: 根据状态获取房间列表

---

## 3. 信令处理模块 (Signaling)

### 3.1 SignalingHandler
- **路径**: `com.whale.lumina.signaling.SignalingHandler`
- **功能**: WebRTC信令处理器，处理信令消息的路由和转发
- **主要接口**:
  - `handleMessage(SignalingMessage message)`: 处理信令消息
  - `createSession(String roomId, String creatorId)`: 创建信令会话
  - `joinSession(String sessionId, String userId)`: 加入信令会话
  - `leaveSession(String sessionId, String userId)`: 离开信令会话
  - `broadcastToSession(String sessionId, SignalingMessage message)`: 向会话广播消息
  - `getActiveConnections()`: 获取活跃连接数 **[新增]**

### 3.2 SignalingStore
- **路径**: `com.whale.lumina.signaling.SignalingStore`
- **功能**: 信令数据存储，管理信令会话和消息的持久化
- **主要接口**:
  - `saveSession(SignalingSession session)`: 保存信令会话
  - `getSession(String sessionId)`: 获取信令会话
  - `saveMessage(SignalingMessage message)`: 保存信令消息
  - `getSessionMessages(String sessionId)`: 获取会话消息列表

### 3.3 SignalingSession
- **路径**: `com.whale.lumina.signaling.SignalingSession`
- **功能**: 信令会话实体类，表示WebRTC信令会话
- **主要属性**: sessionId, roomId, creatorId, participants, status, type, maxParticipants
- **主要方法**:
  - `addParticipant(String userId)`: 添加参与者
  - `removeParticipant(String userId)`: 移除参与者
  - `updateParticipantState(String userId, ParticipantState state)`: 更新参与者状态

### 3.4 SignalingMessage
- **路径**: `com.whale.lumina.signaling.SignalingMessage`
- **功能**: 信令消息实体类，表示WebRTC信令消息
- **主要属性**: messageId, sessionId, type, senderId, receiverId, data, timestamp
- **静态工厂方法**:
  - `createOffer(String sessionId, String senderId, Object data)`: 创建Offer消息
  - `createAnswer(String sessionId, String senderId, Object data)`: 创建Answer消息
  - `createCandidate(String sessionId, String senderId, Object data)`: 创建Candidate消息

---

## 4. 玩家管理模块 (Player Management)

### 4.1 Player
- **路径**: `com.whale.lumina.player.Player`
- **功能**: 玩家实体类，管理玩家信息和状态
- **主要属性**: playerId, userId, username, nickname, level, experience, status, gameStats
- **主要方法**:
  - `updateExperience(int exp)`: 更新经验值
  - `levelUp()`: 升级
  - `updateGameResult(GameResult result)`: 更新游戏结果
  - `addFriend(String friendId)`: 添加好友
  - `blockPlayer(String playerId)`: 屏蔽玩家

### 4.2 PlayerRepository
- **路径**: `com.whale.lumina.player.PlayerRepository`
- **功能**: 玩家数据仓库，管理玩家数据的存储和检索
- **主要接口**:
  - `save(Player player)`: 保存玩家数据
  - `findById(String playerId)`: 根据ID查找玩家
  - `findByUserId(String userId)`: 根据用户ID查找玩家
  - `getOnlinePlayerCount()`: 获取在线玩家数量
  - `searchPlayers(String keyword)`: 搜索玩家
  - `getPlayerRanking(String gameMode)`: 获取玩家排行榜

### 4.3 SessionBindingService
- **路径**: `com.whale.lumina.player.SessionBindingService`
- **功能**: 会话绑定服务，管理玩家与各种会话的绑定关系
- **主要接口**:
  - `bindAuthSession(String playerId, String sessionId)`: 绑定认证会话
  - `bindRoomSession(String playerId, String roomId)`: 绑定房间会话
  - `bindSignalingSession(String playerId, String sessionId)`: 绑定信令会话
  - `unbindAllSessions(String playerId)`: 解绑所有会话
  - `getPlayerBindings(String playerId)`: 获取玩家绑定信息

---

## 5. 匹配系统模块 (Matchmaking)

### 5.1 MatchQueue
- **路径**: `com.whale.lumina.matchmaking.MatchQueue`
- **功能**: 匹配队列管理器，处理不同游戏模式的匹配队列
- **主要接口**:
  - `enqueue(MatchRequest request)`: 将匹配请求加入队列
  - `dequeue(String gameMode)`: 从队列中取出匹配请求
  - `getCandidates(String gameMode, int count)`: 获取匹配候选者
  - `getActiveQueues()`: 获取活跃队列列表
  - `getQueueSize()`: 获取所有队列的总大小 **[新增]**
  - `cleanupExpiredRequests()`: 清理过期请求

### 5.2 MatchRequest
- **路径**: `com.whale.lumina.matchmaking.MatchRequest`
- **功能**: 匹配请求实体类，表示玩家的匹配请求
- **主要属性**: requestId, playerId, gameMode, matchType, criteria, priority, status
- **主要方法**:
  - `calculatePriority()`: 计算匹配优先级
  - `isCompatibleWith(MatchRequest other)`: 检查与其他请求的兼容性
  - `updateStatus(MatchStatus status)`: 更新匹配状态
- **静态工厂方法**:
  - `createQuickMatch(String playerId, String gameMode)`: 创建快速匹配请求
  - `createRankedMatch(String playerId, String gameMode, MatchCriteria criteria)`: 创建排位匹配请求

### 5.3 MatchMaker
- **路径**: `com.whale.lumina.matchmaking.MatchMaker`
- **功能**: 匹配制造器，实现核心匹配算法
- **主要接口**:
  - `processMatching()`: 处理匹配逻辑（定时调用）
  - `processManualMatching(String gameMode)`: 手动触发匹配
  - `quickMatch(List<MatchRequest> requests)`: 快速匹配算法
  - `rankedMatch(List<MatchRequest> requests)`: 排位匹配算法
  - `customMatch(List<MatchRequest> requests, MatchCriteria criteria)`: 自定义匹配算法

### 5.4 MatchResult
- **路径**: `com.whale.lumina.matchmaking.MatchResult`
- **功能**: 匹配结果实体类，表示匹配成功的结果
- **主要属性**: matchId, gameMode, matchType, players, matchTime, qualityScore, roomId
- **主要方法**:
  - `addPlayer(String playerId)`: 添加匹配玩家
  - `updateStatus(MatchStatus status)`: 更新匹配状态
  - `setRoomInfo(String roomId, String serverId)`: 设置房间信息

### 5.5 MatchDispatcher
- **路径**: `com.whale.lumina.matchmaking.MatchDispatcher`
- **功能**: 匹配分发器，处理匹配结果的分发和通知
- **主要接口**:
  - `dispatch(MatchResult result)`: 分发匹配结果
  - `batchDispatch(List<MatchResult> results)`: 批量分发匹配结果
  - `notifyPlayers(MatchResult result)`: 通知匹配玩家
  - `createGameRoom(MatchResult result)`: 创建游戏房间
  - `handlePlayerAcceptance(String matchId, String playerId, boolean accepted)`: 处理玩家接受/拒绝
- **内部类**:
  - `MatchNotification`: 匹配通知类，包含toJson()方法用于序列化 **[新增]**

---

## 6. 监控模块 (Monitoring)

### 6.1 MetricsExporter
- **路径**: `com.whale.lumina.monitoring.MetricsExporter`
- **功能**: 指标导出器，收集和导出系统性能指标
- **主要接口**:
  - `initialize()`: 初始化指标收集器
  - `shutdown()`: 关闭指标收集器
  - `collectMetrics()`: 收集所有指标
  - `getMetric(String name)`: 获取特定指标
  - `setGaugeMetric(String name, double value)`: 设置仪表盘指标
  - `incrementCounter(String name)`: 增加计数器指标
  - `recordHistogram(String name, double value)`: 记录直方图指标
- **使用方式**:
  ```java
  @Autowired
  private MetricsExporter metricsExporter;
  
  metricsExporter.incrementCounter("player.login.count");
  metricsExporter.setGaugeMetric("room.active.count", activeRoomCount);
  ```

### 6.2 HealthEndpoint
- **路径**: `com.whale.lumina.monitoring.HealthEndpoint`
- **功能**: 健康检查端点，提供系统健康状态检查
- **主要接口**:
  - `GET /health`: 基础健康检查
  - `GET /health/detailed`: 详细健康检查
  - `GET /health/ready`: 就绪检查
  - `GET /health/live`: 存活检查
  - `GET /health/component?component={name}`: 组件健康检查
- **内部类**:
  - `ComponentHealthStatus`: 组件健康状态类，新增带参数构造函数 **[新增]**
- **返回格式**:
  ```json
  {
    "status": "UP",
    "message": "系统健康",
    "timestamp": "2024-01-01T12:00:00"
  }
  ```
- **使用方式**: 通过HTTP请求访问健康检查端点，用于监控系统状态

---

## 7. 使用示例

### 7.1 创建房间并加入玩家
```java
// 创建房间
CreateRoomRequest request = new CreateRoomRequest();
request.setName("测试房间");
request.setGameMode("classic");
request.setMaxPlayers(4);

Room room = roomManager.createRoom(request);

// 玩家加入房间
roomManager.joinRoom(room.getRoomId(), "player123");
```

### 7.2 处理匹配请求
```java
// 创建匹配请求
MatchRequest request = MatchRequest.createQuickMatch("player123", "classic");

// 加入匹配队列
matchQueue.enqueue(request);

// 触发匹配
matchMaker.processManualMatching("classic");
```

### 7.3 处理信令消息
```java
// 创建信令消息
SignalingMessage offer = SignalingMessage.createOffer(sessionId, senderId, offerData);

// 处理信令消息
signalingHandler.handleMessage(offer);
```

### 7.4 监控系统状态
```java
// 记录指标
metricsExporter.incrementCounter("api.request.count");
metricsExporter.setGaugeMetric("player.online.count", onlinePlayerCount);

// 检查健康状态
// GET /health - 返回系统整体健康状态
// GET /health/detailed - 返回详细的组件健康状态
```

---

## 8. 注意事项

1. **线程安全**: 所有管理器类都是线程安全的，可以在多线程环境中使用
2. **异常处理**: 所有公共接口都包含适当的异常处理和日志记录
3. **性能考虑**: 使用Redis缓存提高数据访问性能，使用异步处理提高并发能力
4. **扩展性**: 所有模块都支持水平扩展，可以部署多个实例
5. **监控**: 集成了完整的监控和健康检查功能，便于运维管理

---

## 9. 更新记录

- **2024-01-01**: 初始版本，包含所有核心模块的类说明
- **2024-01-XX**: 修复和改进版本
  - 新增 `RoomManager.getActiveRoomCount()` 方法，用于获取活跃房间数量
  - 新增 `MatchQueue.getQueueSize()` 方法，用于获取所有队列的总大小
  - 新增 `SignalingHandler.getActiveConnections()` 方法，用于获取活跃连接数
  - 改进 `MatchDispatcher.MatchNotification` 内部类，添加 `toJson()` 序列化方法
  - 改进 `HealthEndpoint.ComponentHealthStatus` 内部类，新增带参数构造函数
  - 修复 `RoomManager` 中错误代码常量引用问题
- **最后更新**: 2024-01-XX

---

*本文档将随着项目的发展持续更新，请定期查看最新版本。*