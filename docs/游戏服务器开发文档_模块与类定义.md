# 游戏服务器开发文档 — 模块与类定义

> 说明：本文件为实时游戏服务器的详细开发文档，包含整体架构、目录/包/模块规则、每个模块的详细描述、模块对外统一接口（含示例）、以及按单一职责设计的类定义（类名、属性、方法说明）。文档为 Markdown 格式，便于保存与版本控制。

---

## 目录
1. 概述
2. 目录 / 包 / 模块 命名规则
3. 整体架构（模块视角）
4. 模块清单与职责
   - Gateway 模块
   - Signaling 模块
   - Matchmaking 模块
   - WebRTC Coordinator 模块
   - Logic 模块
   - Room 模块
   - Player 模块
   - DataLayer 模块
   - DataChannelProxy 模块
   - Auth & Session 模块
   - AntiCheat 模块
   - Monitoring & Ops 模块
   - Utils / Common 模块
5. 对外统一接口规范（API/消息格式）
6. 示例调用流程（登录、匹配、建链、fallback）
7. 关键类目录与类说明（按模块分组）
8. 开发注意事项与编码规范回顾
9. 完整目录结构图

---

## 1. 概述
本项目采用 Java 为主后端语言（JDK17+），使用 Apache MINA 作为网关网络框架，Redis 做实时缓存，MySQL 做持久化存储。通信采用混合模式：TCP（MINA）做登录/匹配/信令/RPC，WebRTC DataChannel 做高频 P2P 数据（移动/输入），fallback 为服务器中转。

本文件旨在为开发团队提供明确的模块边界、接口约定与类级别职责，避免职责模糊并便于并行开发与测试。

---

## 2. 目录 / 包 / 模块 命名规则
- 项目根包：`com.whale.lumina`。
- 子包规则：`com.whale.lumina.<layer>.<module>`，例如：`com.whale.lumina.gateway.signaling`。
- 代码目录与模块一一对应： `gateway/`, `logic/`, `data/`, `sdk/` 等。
- 接口（Java）命名：以 `I` 前缀或动词后缀（例如 `MatchService`、`IPlayerStore`）。
- 配置文件放置：`config/`，环境区分 `config/prod`, `config/stage`。
- 资源与脚本：`scripts/`, `ops/`。


**说明**：company：whale，game：lumina

---

## 3. 整体架构（模块视角）
- Client ↔ Gateway (MINA)
- Gateway ↔ WebRTC Coordinator (Signaling)
- Gateway ↔ LogicServer (RPC / MessageBus)
- LogicServer ↔ DataLayer (Redis / MySQL)
- Gateway ↔ DataChannelProxy (when fallback)
- Monitoring: Prometheus exporters + Grafana dashboards

---

## 4. 模块清单与职责（高阶）
下面每个模块包含：模块定位、包路径、对外接口、典型调用示例、子类/组件列表与职责说明。

### 4.1 Gateway 模块
- **定位**：网络接入层，处理 TCP 握手、会话管理、初步消息路由与编解码。不能包含复杂游戏逻辑。
- **包路径**：`com.company.game.gateway`
- **依赖**：MINA、protobuf、metrics
- **对外接口**：
  - `Login`（请求/响应）
  - `Heartbeat`（心跳）
  - `Signal`（信令透传）
  - `SendToClient(sessionId, bytes)`（内部调用）
- **典型调用示例**（伪代码）：
  ```java
  GatewayService.login(session, loginReq);
  GatewayService.sendSignal(session, signalingJson);
  ```
- **子组件**：
  - `NetServer`：负责 MINA 启动、端口监听、Session 管理（单一职责）
  - `MessageCodec`：负责 Protobuf/二进制编解码
  - `SessionManager`：管理 session <-> playerId 绑定
  - `GatewayController`：接收解析后的业务消息并分发给下游服务


### 4.2 Signaling 模块
- **定位**：WebRTC 信令处理，负责 SDP/ICE 的转发、验证、短时会话管理。
- **包路径**：`com.company.game.gateway.signaling`
- **接口**：
  - `publishOffer(session, offerJson)`
  - `publishAnswer(session, answerJson)`
  - `publishIceCandidate(session, candidateJson)`
- **子组件**：
  - `SignalingHandler`：解析信令消息并路由
  - `SignalingStore`：短时保存 offer/answer/候选（若需要可用 Redis）

### 4.3 Matchmaking 模块
- **定位**：匹配队列与分配，负责匹配策略、优先级、自动填充。
- **包路径**：`com.company.game.match`
- **接口**：
  - `enqueue(playerId, mode, rank)` -> `ticketId`
  - `cancel(ticketId)`
  - `pollMatch()` -> `MatchResult`
- **子组件**：
  - `MatchQueue`：基于 Redis List 或内存队列实现（持久化/回溯）
  - `MatchMaker`：实现匹配策略（Elo、等级区间等）
  - `MatchDispatcher`：将匹配结果创建房间并分配给 LogicServer

### 4.4 WebRTC Coordinator 模块
- **定位**：协调 P2P 建链流程（通过 Gateway 转发信令），统计 P2P 成功率，触发 fallback 策略。
- **包路径**：`com.company.game.webrtc`
- **接口**：
  - `startNegotiation(roomId, participants)`
  - `reportIceResult(sessionId, success)`
  - `getP2PStats()`
- **子组件**：
  - `NegotiationManager`：并行协调 offer/answer
  - `P2PMonitor`：成功率统计与告警

### 4.5 Logic 模块
- **定位**：游戏规则与房间管理的核心。不可直接操作网络 I/O（由 Gateway 提供）。
- **包路径**：`com.company.game.logic`
- **接口**（对外 RPC）：
  - `createRoom(roomConfig)` -> `roomId`
  - `joinRoom(playerId, roomId)` -> `result`
  - `processInput(playerId, roomId, input)` (幂等/带序号)
  - `tick(roomId)`（内部驱动或调度）
- **子组件**：
  - `RoomManager`：房间生命周期管理（创建/销毁/迁移）
  - `GameLoop`：帧驱动或定时任务，负责调用 `Room.tick()`
  - `CombatService`：纯业务计算（单一职责：战斗计算）
  - `StateSyncService`：生成广播快照

### 4.6 Room 模块
- **定位**：房间内玩家与状态的内存表示与同步逻辑。
- **包路径**：`com.company.game.logic.room`
- **接口**：
  - `addPlayer(player)` / `removePlayer(player)`
  - `applyInput(playerId, input)`
  - `getSnapshot()` -> `RoomSnapshot`
- **子组件**：
  - `RoomState`（纯数据对象）
  - `RoomScheduler`（房间内任务）

### 4.7 Player 模块
- **定位**：玩家会话、基本数据载体与状态恢复。
- **包路径**：`com.company.game.player`
- **接口**：
  - `loadPlayer(playerId)` -> `Player`（从 MySQL/Redis）
  - `savePlayer(player)`
- **子组件**：
  - `PlayerRepository`（IPlayerStore 实现）
  - `SessionBindingService`（绑定 session <-> player）

### 4.8 DataLayer 模块
- **定位**：对 Redis 与 MySQL 的抽象层，提供统一数据访问接口。
- **包路径**：`com.company.game.data`
- **接口**：
  - `getPlayerState(playerId)`, `setPlayerState(playerId, state)`
  - `appendMatchQueue(mode, ticket)`
  - `persistBattleRecord(record)`
- **子组件**：
  - `RedisClient`（封装常用操作）
  - `MySQLClient`（DAO 层）
  - `DataSyncService`（定时落库/批量写入）

### 4.9 DataChannelProxy 模块
- **定位**：当 P2P 建链失败或策略需要时，提供可靠的服务器中转路径。
- **包路径**：`com.company.game.proxy`
- **接口**：
  - `relayInput(fromPlayerId, toRoomId, payload)`
  - `startProxySession(sessionId)`
- **子组件**：
  - `ProxyRouter`（选择合适的中转逻辑，支持同机房优先）
  - `ProxyBuffer`（短时缓冲）

### 4.10 Auth & Session 模块
- **定位**：登录、鉴权、token 管理、CSRF/Replay 防护。
- **包路径**：`com.company.game.auth`
- **接口**：
  - `authenticate(credentials)` -> `AuthToken`
  - `validateToken(token)` -> `playerId`
- **子组件**：
  - `AuthService`（JWT 或自研 token）
  - `SessionStore`（Redis 映射）

### 4.11 AntiCheat 模块
- **定位**：规则检测与告警，尽可能在 Logic 层和网关层做速率/边界检测。
- **包路径**：`com.company.game.anticheat`
- **接口**：
  - `checkInput(input)` -> `CheckResult`
  - `reportSuspicious(playerId, reason)`
- **子组件**：
  - `RateLimiter`（token-bucket）
  - `MovementValidator`（位置/速度校验）

### 4.12 Monitoring & Ops 模块
- **定位**：Prometheus 指标、健康检查、日志采集与报警接口。
- **包路径**：`com.company.game.monitor`
- **接口**：
  - `reportMetric(name, value)`
  - `healthCheck()` -> `HealthStatus`
- **子组件**：
  - `MetricsExporter`（Micrometer）
  - `HealthEndpoint`（/health）

### 4.13 Utils / Common 模块
- **定位**：通用工具（序列化、错误码、常量、时间工具等）。
- **包路径**：`com.company.game.common`
- **接口**：常量类、异常基类、序列化工具

---

## 5. 对外统一接口规范（API / 消息格式）
- 全部服务间 RPC 使用 Protobuf 编码，消息采用 `RpcRequest(methodId, payload)` 的通用包。
- Gateway 与客户端消息分为：`Control`（登录/心跳/信令）与 `Game`（输入/同步）。
- DataChannel 消息使用简短二进制帧：`[1B: msgType][4B: seq][N: payload]`。

**示例：Login 请求 (JSON over TCP)**
```json
{
  "type": "LoginReq",
  "payload": {"username":"alice","token":"..."}
}
```

**示例：PlayerInput (DataChannel binary)**
- msgType = 1
- seq = 123
- payload = protobuf(PlayerInput)

---

## 6. 示例调用流程（核心流程）
### 6.1 登录流程
1. 客户端 -> Gateway: `LoginReq`（包含 token）
2. Gateway -> AuthService: `validateToken` -> 返回 playerId
3. Gateway: `SessionManager.bind(session, playerId)`
4. Gateway 返回 `LoginResp` 给客户端

### 6.2 匹配流程
1. 客户端 -> Gateway: `MatchReq(mode)`
2. Gateway -> MatchService.enqueue(playerId,...)
3. MatchMaker 找到一组玩家 -> MatchDispatcher 创建 room -> 分配 LogicServer
4. Gateway 告知客户端房间信息并触发 WebRTC 协商

### 6.3 建链与 P2P 流程（简化）
1. Gateway 转发 SDP offer/answer 与 ICE candidate
2. ClientA <-> ClientB 尝试建立 DataChannel（若直接成功则 P2P）
3. 若尝试超时或失败，WebRTC Coordinator 标记失败并触发 DataChannelProxy

### 6.4 游戏进行中的输入处理
1. Client 通过 DataChannel 发送 `PlayerInput`（短帧）
2. 若 P2P：input 直达对端并备份给逻辑服（可选）；若 Proxy：Gateway 转发至 Logic
3. Logic `processInput` 校验并更新 `RoomState`，生成 `ServerUpdate`
4. Gateway 将 `ServerUpdate` 广播给房间成员（P2P 时由一方发起/或由 server 发起）

---

## 7. 关键类目录与类说明（按模块）
下面列举每个模块内主要类，遵循单一职责。每个类包含：功能、关键属性、关键方法（签名 + 描述）。不提供实现代码。

### 7.1 Gateway 模块类

#### `NetServer`
- **描述**：启动与停止网络服务（MINA），监听端口并接收 TCP 连接。
- **关键属性**:
  - `int port`：监听端口
  - `IoAcceptor acceptor`：MINA 接受器
- **关键方法**:
  - `void start()`：启动服务并绑定端口
  - `void stop()`：优雅关闭服务
  - `void registerHandler(IoHandler handler)`：注册业务处理器

#### `SessionManager`
- **描述**：管理 IoSession 与 playerId 的绑定，处理 session 生命周期。
- **关键属性**:
  - `ConcurrentHashMap<String, IoSession> sessionsById`
  - `ConcurrentHashMap<Long, String> playerToSessionId`
- **关键方法**:
  - `void bind(sessionId, playerId)`：绑定
  - `void unbind(sessionId)`：解绑
  - `Optional<IoSession> getSessionByPlayer(playerId)`：查询

#### `MessageCodec`
- **描述**：负责消息的编解码（Protobuf / 二进制帧）。
- **关键方法**:
  - `byte[] encode(Object message)`
  - `Object decode(byte[] bytes)`

#### `GatewayController`
- **描述**：接收来自 NetServer 的业务消息并调用相应子服务（Auth、Match、Signaling）。
- **关键方法**:
  - `void handleLogin(IoSession session, LoginReq req)`
  - `void handleSignal(IoSession session, SignalMsg msg)`
  - `void handleGameMsg(IoSession session, byte[] payload)`


### 7.2 Signaling 模块类

#### `SignalingHandler`
- **描述**：解析并转发 SDP/ICE 消息到目标 session 或存储以便 later retrieval。
- **关键属性**:
  - `SignalingStore store`
- **关键方法**:
  - `void onOffer(session, OfferMsg)`
  - `void onAnswer(session, AnswerMsg)`
  - `void onIceCandidate(session, CandidateMsg)`

#### `SignalingStore`
- **描述**：临时存储信令数据（可选 Redis 支持），单一职责为存取。
- **关键方法**:
  - `void saveOffer(roomId, playerId, offerJson)`
  - `Optional<String> loadOffer(roomId, playerId)`


### 7.3 Matchmaking 模块类

#### `MatchQueue`
- **描述**：封装匹配队列（Redis 或本地实现），负责入队/出队/取消。
- **关键方法**:
  - `String enqueue(MatchTicket ticket)`
  - `boolean cancel(String ticketId)`
  - `List<MatchTicket> poll(int batchSize)`

#### `MatchMaker`
- **描述**：实现匹配算法（根据等级、段位、延迟等），职责为从队列中挑选一组兼容玩家。
- **关键方法**:
  - `Optional<MatchResult> tryMatch()`

#### `MatchDispatcher`
- **描述**：把匹配结果落地：创建房间、通知 Logic 与 Gateway。
- **关键方法**:
  - `void dispatch(MatchResult result)`


### 7.4 WebRTC Coordinator 类

#### `NegotiationManager`
- **描述**：管理并发的 offer/answer 流程，保证超时回退。
- **关键属性**:
  - `ConcurrentHashMap<String, NegotiationContext> contexts`
- **关键方法**:
  - `void startNegotiation(roomId, participants)`
  - `void onTimeout(contextId)`

#### `P2PMonitor`
- **描述**：收集 P2P 成功/失败数据，触发报警或 fallback 策略。
- **关键方法**:
  - `void reportResult(sessionId, boolean success)`
  - `P2PStats getStats()`


### 7.5 Logic / Room 模块类

#### `RoomManager`
- **描述**：房间生命周期管理（创建/销毁/迁移），分配 `Room` 实例到线程或进程。
- **关键属性**:
  - `ConcurrentHashMap<String, Room> rooms`
- **关键方法**:
  - `Room createRoom(RoomConfig config)`
  - `void destroyRoom(String roomId)`
  - `Optional<Room> getRoom(String roomId)`

#### `Room`
- **描述**：单个房间的内存模型，负责管理 `RoomState`、玩家、并执行 `tick()`。
- **关键属性**:
  - `String roomId`
  - `RoomState state`
  - `List<PlayerRef> players`
  - `ScheduledFuture<?> tickTask`
- **关键方法**:
  - `void addPlayer(PlayerRef p)`
  - `void removePlayer(playerId)`
  - `void applyInput(playerId, Input input)`
  - `RoomSnapshot getSnapshot()`
  - `void tick()`

#### `GameLoop`
- **描述**：负责驱动 `Room.tick()`（可以为单线程事件循环或线程池调度）。
- **关键方法**:
  - `void start()`
  - `void stop()`
  - `void scheduleRoomTick(roomId)`

#### `CombatService`
- **描述**：纯计算模块，接收两个状态并返回计算后的变更结果（纯函数式风格推荐）。
- **关键方法**:
  - `CombatResult resolveActions(List<Action> actions, RoomState state)`


### 7.6 Player 模块类

#### `Player`
- **描述**：业务玩家实体，包含基础属性和值对象。
- **关键属性**:
  - `long playerId`
  - `String name`
  - `PlayerStats stats`
  - `PlayerState runtimeState`（x,y,health 等）
- **关键方法**:
  - `void applyDelta(PlayerDelta delta)`

#### `PlayerRepository`（接口）
- **描述**：抽象持久化操作（单一职责：数据存取）。
- **关键方法**:
  - `Player load(long playerId)`
  - `void save(Player p)`


### 7.7 DataLayer 模块类

#### `RedisClient`
- **描述**：封装常用 Redis 操作，提供高层原子操作。
- **关键方法**:
  - `String lpush(String key, String val)`
  - `List<String> brpop(String key, int timeout)`
  - `void hset(String key, Map<String,String> map)`

#### `DataSyncService`
- **描述**：定时把 Redis 热数据落地到 MySQL，负责批量写入与幂等处理。
- **关键方法**:
  - `void flushToDB()`


### 7.8 DataChannelProxy 模块类

#### `ProxyRouter`
- **描述**：选择中转目标（本机 / 同机房 / 跨机房），并记录路由统计。
- **关键方法**:
  - `ProxyTarget selectTarget(playerId, roomId)`

#### `ProxySession`
- **描述**：代表一个中转会话（短时缓冲、回溯）。
- **关键属性**:
  - `String sessionId`
  - `Queue<Frame> buffer`
- **关键方法**:
  - `void pushFrame(Frame f)`
  - `Frame pollFrame()`


### 7.9 Auth & Session 模块类

#### `AuthService`
- **描述**：处理登录鉴权、token 签发与验证（建议使用 JWT + Redis 黑名单）。
- **关键方法**:
  - `AuthToken authenticate(Credential c)`
  - `Optional<Long> validateToken(String token)`

#### `SessionStore`
- **描述**：存储 session 映射（sessionId -> playerId），用于跨进程可共享时使用 Redis。
- **关键方法**:
  - `void set(String sessionId, long playerId)`
  - `Optional<Long> getPlayerId(String sessionId)`


### 7.10 AntiCheat 模块类

#### `RateLimiter`
- **描述**：对 PlayerInput 做速率限制，防止刷包。
- **关键方法**:
  - `boolean tryAcquire(playerId)`

#### `MovementValidator`
- **描述**：检查位置更新、速度是否超出阈值。
- **关键方法**:
  - `CheckResult validate(positionBefore, positionAfter, dt)`


### 7.11 Monitoring & Ops 模块类

#### `MetricsExporter`
- **描述**：封装 Micrometer/Prometheus 的指标注册，提供便捷方法上报业务指标。
- **关键方法**:
  - `void gauge(String name, Supplier<Number> supplier)`
  - `void increment(String name)`

#### `HealthEndpoint`
- **描述**：提供 /health 检查，用于 K8s 探活。
- **关键方法**:
  - `HealthStatus check()`


### 7.12 Utils / Common 类
- `ErrorCodes`：项目统一错误码（常量）
- `ProtoUtils`：Protobuf 序列化辅助
- `TimeUtils`：时间相关工具

---

## 8. 开发注意事项与编码规范回顾
1. 单一职责：每个类只做一件事；若出现多职责，拆分。
2. 非阻塞 I/O：MINA 的 I/O 线程禁止运行阻塞或计算密集型逻辑。
3. 并发容器优先：使用 ConcurrentHashMap 等无锁或少锁结构。
4. 错误与异常：捕获并记录上下文，避免吞掉异常。
5. 序列化：服务间使用 Protobuf；客户端可选 JSON for control messages。
6. 性能：避免频繁 new 对象，使用对象池或缓冲。
7. 日志：结构化日志（JSON 格式），重要事件增加 traceId。
8. 代码注释：类注释包含线程安全说明、输入输出及异常语义。

---
## 9. 完整目录结构图

以下为项目的目录与包层级结构树：

  

```plaintext

com/company/game/

├── gateway/                  # 网络接入层

│   ├── NetServer.java

│   ├── SessionManager.java

│   ├── MessageCodec.java

│   └── GatewayController.java

│   └── signaling/            # WebRTC 信令子模块

│       ├── SignalingHandler.java

│       └── SignalingStore.java

│

├── match/                    # 匹配模块

│   ├── MatchQueue.java

│   ├── MatchMaker.java

│   └── MatchDispatcher.java

│

├── webrtc/                   # WebRTC 协调模块

│   ├── NegotiationManager.java

│   └── P2PMonitor.java

│

├── logic/                    # 核心逻辑模块

│   ├── RoomManager.java

│   ├── GameLoop.java

│   ├── CombatService.java

│   └── room/                 # 房间子模块

│       ├── Room.java

│       ├── RoomState.java

│       └── RoomScheduler.java

│

├── player/                   # 玩家模块

│   ├── Player.java

│   ├── PlayerRepository.java

│   └── SessionBindingService.java

│

├── data/                     # 数据层

│   ├── RedisClient.java

│   ├── MySQLClient.java

│   └── DataSyncService.java

│

├── proxy/                    # DataChannel 中转模块

│   ├── ProxyRouter.java

│   └── ProxySession.java

│

├── auth/                     # 鉴权与会话

│   ├── AuthService.java

│   └── SessionStore.java

│

├── anticheat/                # 反作弊模块

│   ├── RateLimiter.java

│   └── MovementValidator.java

│

├── monitor/                  # 监控与运维

│   ├── MetricsExporter.java

│   └── HealthEndpoint.java

│

├── common/                   # 工具与通用

│   ├── ErrorCodes.java

│   ├── ProtoUtils.java

│   └── TimeUtils.java

│

└── config/                   # 配置文件目录

    ├── application.yml

    ├── prod/

    └── stage/

```
 

此目录结构图完整展示了包划分、子模块归属及主要类的分布情况，保证单一职责与模块化清晰性。
  

---
## 10. 下一步说明
- 以本文档为基础为每个接口编写 `OpenAPI` / `protobuf` 规范文件并放入 `specs/` 目录。
- 为每个模块建立单元测试骨架（接口 mock），优先覆盖 `Room` 与 `MatchMaker`。
- 生成 Class/UML 图以便跨团队讨论。

---

*文档结束 — 若需将此文档导出为 `游戏服务器开发文档.md` 并提供下载链接，或需要我把每个类生成对应的接口模板（Java interface + Javadoc），请告诉我你想要的格式与范围，我会直接保存并导出。*